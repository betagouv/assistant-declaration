# Intégration des éditeurs de billetterie

> **Rappel :**\
> La plateforme a été créée pour simplifier les déclarations des entrepreneurs du spectacle vivant. Notre but est d'utiliser les données du déclarant qui sont déjà "numérisées" côté éditeurs pour les proposer à la télédéclaration auprès des organismes de collecte de taxes et de droits.

## Stratégie initiale depuis la plateforme _#pull_

Nous avons créé des connecteurs afin que la plateforme puisse synchroniser les données des déclarants depuis les éditeurs disposant d'une API. Les données indispensables que les API doivent exposer sont :

- Liste des spectacles, dont :
  - Leur nom ;
  - Leur taux de TVA ;
  - Leurs séances, dont :
    - La date ;
  - Leurs tarifs (catégories de billets), dont :
    - Le nombre de billets vendus/donnés pour chaque catégorie.

**En aucun cas nous ne stockons de données sensibles des spectateurs (ni nom, ni adresse, ni téléphone) même s'ils sont accessibles avec les accès en lecture seule qui nous ont été donnés.**

De plus, la synchronisation se fait de manière différentielle afin de réduire l'impact sur les serveurs : à chaque synchronisation nous allons regarder les derniers billets émis depuis la dernière fois, afin de seulement resynchroniser les spectacles ayant des mises à jour. Cela reste une opération manuelle du déclarant, en moyenne cela devrait représenter très peu de synchronisations dans le mois.

L'objectif de cette stratégie de déploiement a été de **pouvoir lancer notre plateforme sans solliciter les éditeurs dans le moindre développement informatique**.

Pour autant, cette stratégie ne nous permet pas une compatibilité avec tout l'écosystème des éditeurs de billetterie :

- Certains éditeurs n'ont pas la donnée centralisée (logiciel chez le déclarant...) ;
- Certains éditeurs n'ont pas d'API ;
- Certaines données requises ne sont pas exposées dans l'API ;
- L'éditeur est inquiet pour l'impact sur les performances de ces serveurs ;
- ...

Voilà pourquoi nous avons proposé a posteriori l'alternative d'une API dédiée de notre côté, pour laisser la possibilité aux éditeurs de "pousser" les données sur notre plateforme.

_À noter que cela en remplacera pas la stratégie initiale. Si vous avez une API compatible il et que vous souhaitez que l'on fasse un connecteur pour vous, n'hésitez pas à nous contacter directement._

## Stratégie alternative depuis l'éditeur _#push_

L'alternative est que l'éditeur puisse pousser les données de billetterie d'un déclarant sur la plateforme. Cela demande quelques modifications informatiques de votre outil de billetterie mais cela devrait rester sommaire.

**Nous tentons ci-dessous d'apporter un peu de contexte métier sur comment intégrer notre API. Il est fortement conseillé de lire ces passages avant de passer directement à l'intégration technique.**

_Si jamais vous avez un doute sur l'intégration de notre API ou une suggestion, nous restons à disposition pour y apporter des améliorations._

### La déclaration ne pourra pas se faire depuis votre outil

Notre API va **seulement** vous permettre de nous pousser les données de billetterie, mais vous ne pourrez pas déclencher une déclaration auprès d'un organisme depuis votre outil. En effet nous ne souhaitons pas faire fuiter la logique métier des organismes sur votre outil car :

1. Vous auriez à demander les champs spécifiques de chaque organisme ;
2. Il est possible que nous soyons compatibles avec plus d'organismes à l'avenir, ce qui induirait des changements sur votre outil ;
3. Nous travaillons avec les organismes pour tenter de simplifier les démarches officielles (ce qui induit aussi petit à petit des changements).

### Le déclenchement de la synchronisation des données

**Au moment de déclarer un spectacle depuis notre plateforme le déclarant doit avoir lesdites données à jour.** Ce que nous proposons avec la _stratégie initiale_ c'est de laisser le déclarant manuellement synchroniser les données de l'éditeur dans notre plateforme. Cela pour plusieurs raisons :

- L'utilisateur a la certitude que cette opération synchrone a échoué ou non (et sait donc si la plateforme a bien les dernières données) ;
- Les déclarations d'un spectacle sont rares, il n'y a donc pas d'intérêt à nous envoyer des mises à jour automatique et très fréquente (qui impliquerait aussi une gestion additionnelle en cas d'erreur).

C'est pourquoi avoir dans votre outil un bouton comme `Synchroniser les données dans l'Assistant déclaration` reste selon nous le plus simple. Celui-ci devrait être situé sur la page de chaque spectacle.

### Le moment à laquel proposer la synchronisation des données

A priori le bouton de synchronisation dans votre outil devrait être actionnable une fois la dernière représentation du spectacle passée. Nous conseillons toutefois dans l'afficher grisé (désactivé) avec une infobulle au survol pour expliquer au déclarant que cette action n'est disponible qu'au moment que vous aurez choisi. _Certains éditeurs par exemple permettent une clôture définitive du spectacle bloquant ainsi toute modification de billetterie (remboursement...), cela peut être le moment pour "activer" le bouton de synchronsiation._

Notre API autorise les éditeurs à synchroniser plusieurs fois un même spectacle. Cela est utile dans les cas où :

- Une fois sur notre plateforme l'utilisateur s'aperçoit d'informations à ajuster comme des tickets mal renseignés (il est ainsi en mesure de modifier à la source de vérité chez vous, puis de resynchroniser) ;
- Si pour ce spectacle une date est ajoutée.

> Pour information, nous investiguons la possibilité d'établir un référentiel des données de programmation. Techniquement cela peut réutiliser la synchronisation des données de billetterie à la création de nouvelles dates (synchronisations possiblement automatiques de l'éditeur avec les données de billetterie vides).\
> \
> Les informations considérées comme publiques pourraient être partagées avec des partenaires (nom du spectacle, dates de représentations). L'avantage serait double :
>
> 1. Les organismes passent pas mal de temps à scruter les programmations pour savoir ce qui est joué, cela leur apporterait un référentiel supplémentaire ;
> 2. Beaucoup de déclarants nous ont partagé qu'après un spectacle ils ne savent pas toujours auxquels organismes déclarer (règles complexes...), le référentiel aiderait les organismes à :
>    - Nous faire un retour sur l'éligibilité d'un spectacle à tels droits ou taxes afin d'ajuster notre formulaire de déclaration sur la plateforme ;
>    - Être proactif si rien n'est reçu.

### La recette de billetterie doit être détaillée par catégorie de billet

En fonction des organismes le total HT ou TTC du spectacle peut être suffisant, des fois il faut le spécifier par représentation, et des fois il faut spécifier la répartition d'entrées payantes et gratuites.

Comme en plus le déclarant peut avoir besoin :

1. D'ajuster les entrées si cela n'est pas possible chez l'éditeur (par exemple des entrées vendues sans le logiciel de billetterie) ;
2. De supprimer certaines catégories pour la déclaration (l'usage de la billetterie est parfois détournée pour vendre des choses autres que des places).

... nous avons fait le choix de demander la recette par catégorie de billet par représentation. Donnant la possibilité au déclarant depuis notre plateforme de s'assurer de la cohérence de ce qu'il s'apprête à déclarer, de manière uniformisé qu'il ait un éditeur ou plusieurs connectés.

Par exemple s'il y a eu 5 billets émis pour une représentation, nous n'avons pas besoin de chaque billet détaillé mais des sommes comme :

| Identifiant éditeur | Catégorie de billet | Prix du billet TTC | Nombre émis |
| ------------------- | ------------------- | ------------------ | ----------- |
| `cat_1`             | Catégorie adulte    | 10 €               | 3           |
| `cat_2`             | Catégorie enfant    | 0 €                | 2           |

> Il arrive que des catégories de billet aient un prix dynamique au cours des ventes. Par exemple si la catégorie adulte était vendue à 12 € puis 10 €, il faudrait par exemple la séparer en :
>
> - `cat_1_1200`: Catégorie adulte (n°1)
> - `cat_2_1000`: Catégorie adulte (n°2)

### Structuration des endpoints

Nous proposons 2 endpoints :

- 1 en écriture ("mutater") pour pousser un nouveau spectacle ou modifier un spectacle. Une modification de spectacle équivaut une action HTTP `PUT` (et non un `PATCH`). L'idée est que vous n'ayez pas à gérer plusieurs appels pour ajouter/modifier/supprimer différentes entités qui doivent en plus être associées entre-elles. Nous prenons l'état `A` en cours dans notre base de données et le comparons à l'état `B` que vous nous envoyez afin de faire la diférentiel nécessaire pour ajuster l'état en base de données ;
- 1 en lecture ("getter") qui ne devrait servir qu'à des fins de debug pour vous assurer durant vos tests qu'une "mutation" a correctement été prise en compte par notre plateforme.

### Les clients SDK pour l'API

Nous avons fait le choix de ne pas développer et maintenir nos propres clients SDK car :

- Chaque éditeur a pu utiliser un langage de programmation différent ;
- La maintenance manuelle de chaque client aurait de grandes chances de diverger avec le temps ;
- On s'enlève la gestion de packages (pour chaque langage).

Mais **nous proposons un document [OpenAPI (anciennement Swagger)](https://www.openapis.org/)** directement généré depuis l'implémentation de nos endpoints. Cela vous permet d'utiliser des générateurs de clients SDK suivant vos contraintes, et nous permet de garantir une documentation technique à jour par rapport aux modifications de l'API.

Le plus simple pour bien choisir votre "générateur de client SDK" est de regarder sur GitHub une librairie ayant assez de popularité pour le langage visé, avec une licence sans restriction (`MIT` idéalement). À titre indicatif, pour générer un client TypeScript on trouve un large écosystème :

- [OpenAPI Generator](https://openapi-generator.tech/) _(propose quasiment [tous les langages et tout type de librairie de requêtage](https://openapi-generator.tech/docs/generators/))_
- [`openapi-typescript`](https://github.com/openapi-ts/openapi-typescript)
- [`openapi-ts`](https://github.com/hey-api/openapi-ts)
- [`orval`](https://github.com/orval-labs/orval)
- ...

**Vous trouverez le document `openapi.json` [disponible ici](https://assistant-declaration.beta.gouv.fr/openapi.json)**, et un aperçu de la documentation technique [sur la page suivante](/docs/ticketing-api-definition).

> L'un des principaux avantages du client SDK est si vous utilisez le typage dans votre langage de programmation. Cela vous donnera un minimum de garantie au moment de la compilation/transpilation.
>
> Nous allons tout faire pour permettre la rétrocompatibilité de nos modifications. Mais vous pouvez tout à fait dans votre intégration continu (CI/CD) récupérer notre document `openapi.json` et tester s'il y a des différences avec le client SDK généré que vous aviez committé auparavant.

_(À noter qu'au vu du faible nombre d'endpoints actuellement, vous pouvez aussi coder "en brut" les requêtes malgré quelques avantages perdus)_

...

---

TODO:

- comment l'user crée son compte
- chaque nouvel éditeur doit se déclarer pour qu'on lui créer une "card" dédié avec son nom
- à disposition s'il y a le moindre souci
- lien unique pour tomber sur la bonne déclaration dans notre outil (il doit être get par un appel... car il pourrait changer)
- tester sur la dev ...
- on doit créer un identifiant pour eux en base ? ou pas ... ? mais pour faire leurs tests... hmm
- TODO: quid des tarifs avec des promotions à l'achat

* import postman du schema openapi pour tester..

  .

* comment cela devrait être pour l'user (dans l'interface ...), aussi token unique par utilisateur

### aaa

aaa

### bbb

bbb
